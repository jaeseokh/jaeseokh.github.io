<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jaeseok Hwang">
<meta name="dcterms.date" content="2024-09-01">

<title>Advanced Analysis of Crop Yield Response to Nitrogen (Econometrics) – Jaeseok Hwang</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles/styles.scss">
<meta property="og:title" content="Advanced Analysis of Crop Yield Response to Nitrogen (Econometrics) – Jaeseok Hwang">
<meta property="og:description" content="">
<meta property="og:site_name" content="Jaeseok Hwang">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">
      Jaeseok Hwang
      </li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Jaeseok Hwang</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../about/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">About</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../docs/Resume.pdf" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Resume</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../papers/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Papers</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../researchnote/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Machine Learning and Data Analytics</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content column-page-right" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Advanced Analysis of Crop Yield Response to Nitrogen (Econometrics)</h1>
</div>



<div class="quarto-title-meta column-page-right">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Jaeseok Hwang </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 1, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="expanding-the-simple-regression-analysis" class="level2">
<h2 class="anchored" data-anchor-id="expanding-the-simple-regression-analysis">Expanding the Simple Regression Analysis</h2>
<p>Now, we can expand the simple regression analysis to a more complex framework that better reflects the real-world setting of crop yield response to nitrogen.</p>
<p>From my five years as a Research Assistant (RA) for the Data Intensive Farm Management (DIFM) project <em>(Cite: DSB, 2019)</em>, I have developed and applied various regression methods to model crop yield response to nitrogen. These models range from analyzing data at the single-field level to examining multiple farms across multiple years of on-farm field experiments.</p>
<hr>
</section>
<section id="yield-response-modeling-at-the-single-field-level" class="level2">
<h2 class="anchored" data-anchor-id="yield-response-modeling-at-the-single-field-level">Yield Response Modeling at the Single Field Level</h2>
<section id="data-context" class="level3">
<h3 class="anchored" data-anchor-id="data-context">Data Context</h3>
<p>In a single field setting, we typically collect the following data: <br> - <strong>Yield (<span class="math inline">\(Y\)</span>):</strong> Crop yield for each plot in the field <br> - <strong>Nitrogen (<span class="math inline">\(N\)</span>):</strong> Nitrogen input <br> - <strong>Seed Rate (<span class="math inline">\(S\)</span>):</strong> Seeding density <br> - <strong>Topographical Features:</strong> Elevation, slope, and aspect <br> - <strong>Soil Quality Metrics:</strong> Soil nutrition and water-storage capacity <br></p>
<p>Given the variability in field conditions and weather uncertainties, traditional parametric models may struggle to capture the yield response effectively. To address this, we employ a Generalized Additive Model (GAM), a non-parametric approach that flexibly fits relationships between variables.</p>
<hr>
</section>
<section id="generalized-additive-model-for-yield-response" class="level3">
<h3 class="anchored" data-anchor-id="generalized-additive-model-for-yield-response">Generalized Additive Model for Yield Response</h3>
<p>The GAM regression model can be expressed as:</p>
<p><span class="math display">\[ Y = \beta_0 + f_1(N) + f_2(S) + f_3(\text{Elevation}) + f_4(\text{Slope}) + f_5(\text{Soil Quality}) + \epsilon \]</span></p>
<p>Where: <br> - <span class="math inline">\(f_1, f_2, \ldots\)</span> = Smooth functions capturing nonlinear relationships <br> - <span class="math inline">\(\epsilon\)</span> = Error term <br></p>
<hr>
</section>
<section id="example-gam-regression-with-synthetic-data" class="level3">
<h3 class="anchored" data-anchor-id="example-gam-regression-with-synthetic-data">Example: GAM Regression with Synthetic Data</h3>
<p>The following R code demonstrates how to implement a GAM regression model to estimate yield response to nitrogen and other explanatory variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load necessary libraries</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mgcv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: nlme</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>This is mgcv 1.9-1. For overview type 'help("mgcv-package")'.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate synthetic data</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>nitrogen <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, <span class="dv">0</span>, <span class="dv">200</span>)  <span class="co"># Nitrogen input</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>seed_rate <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, <span class="dv">5</span>, <span class="dv">10</span>)  <span class="co"># Seeding rate</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>elevation <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">100</span>, <span class="dv">10</span>)  <span class="co"># Elevation</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>slope <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">5</span>, <span class="dv">2</span>)  <span class="co"># Slope</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>soil_quality <span class="ot">&lt;-</span> <span class="fu">runif</span>(n, <span class="dv">0</span>, <span class="dv">100</span>)  <span class="co"># Soil quality</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>error <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n, <span class="dv">0</span>, <span class="dv">5</span>)  <span class="co"># Random error</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate yield response</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>yield <span class="ot">&lt;-</span> <span class="dv">50</span> <span class="sc">+</span> <span class="fl">0.8</span> <span class="sc">*</span> nitrogen <span class="sc">-</span> <span class="fl">0.002</span> <span class="sc">*</span> nitrogen<span class="sc">^</span><span class="dv">2</span> <span class="sc">+</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>         <span class="fl">0.5</span> <span class="sc">*</span> seed_rate <span class="sc">+</span> <span class="fl">0.2</span> <span class="sc">*</span> elevation <span class="sc">-</span> <span class="fl">0.1</span> <span class="sc">*</span> slope <span class="sc">+</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>         <span class="fl">0.05</span> <span class="sc">*</span> soil_quality <span class="sc">+</span> error</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a data frame</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Yield =</span> yield, <span class="at">Nitrogen =</span> nitrogen, <span class="at">SeedRate =</span> seed_rate,</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>                   <span class="at">Elevation =</span> elevation, <span class="at">Slope =</span> slope, <span class="at">SoilQuality =</span> soil_quality)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a GAM model</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>gam_model <span class="ot">&lt;-</span> <span class="fu">gam</span>(Yield <span class="sc">~</span> <span class="fu">s</span>(Nitrogen) <span class="sc">+</span> <span class="fu">s</span>(SeedRate) <span class="sc">+</span> <span class="fu">s</span>(Elevation) <span class="sc">+</span> </span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>                   <span class="fu">s</span>(Slope) <span class="sc">+</span> <span class="fu">s</span>(SoilQuality), <span class="at">data =</span> data)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate predictions for plotting</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>Predicted_Yield <span class="ot">&lt;-</span> <span class="fu">predict</span>(gam_model)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot observed vs. predicted yield</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(data, <span class="fu">aes</span>(<span class="at">x =</span> Nitrogen, <span class="at">y =</span> Yield)) <span class="sc">+</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">color =</span> <span class="st">"green"</span>, <span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.6</span>) <span class="sc">+</span>  <span class="co"># Observed data</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> Predicted_Yield), <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">1</span>) <span class="sc">+</span>  <span class="co"># GAM prediction</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"GAM Regression: Yield Response to Nitrogen"</span>,</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Nitrogen Input (kg/ha)"</span>,</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Yield (kg/ha)"</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
ℹ Please use `linewidth` instead.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="E03-Spatial-and-Time-Series_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="strengths-of-gam-regression" class="level3">
<h3 class="anchored" data-anchor-id="strengths-of-gam-regression">Strengths of GAM Regression</h3>
<p>GAM regression offers significant advantages in modeling crop yield response:</p>
<ol type="1">
<li><p><strong>Flexibility</strong>: GAM allows for smooth, nonlinear relationships between yield and explanatory variables. This is particularly important for agricultural data, where yield response to nitrogen often exhibits nonlinear patterns due to biological limits.</p></li>
<li><p><strong>Interpretability</strong>: The smooth terms in GAM provide an intuitive understanding of how each input influences yield.</p></li>
<li><p><strong>Handling Variability</strong>: GAM is robust to field-specific heterogeneity and weather uncertainties, making it ideal for modeling yield response in diverse agricultural settings.</p></li>
</ol>
<p>By applying GAM regression at the single-field level, we can capture the intricate relationships between yield and its determinants, paving the way for more nuanced analyses at larger spatial and temporal scales.</p>
<p>Cite : <span class="citation" data-cites="hastie2017generalized">Hastie (<a href="#ref-hastie2017generalized" role="doc-biblioref">2017</a>)</span> , <span class="citation" data-cites="wood2017generalized">Wood (<a href="#ref-wood2017generalized" role="doc-biblioref">2017</a>)</span></p>
</section>
</section>
<section id="expand-model-to-spatial-and-time-series-analysis-regression" class="level2">
<h2 class="anchored" data-anchor-id="expand-model-to-spatial-and-time-series-analysis-regression">Expand model to Spatial and Time-Series analysis (regression)</h2>
<p>Having explored yield response at the single-field level, we now extend the analysis to account for more complex real-world scenarios. These scenarios include multiple fields across different farms and states in the first year of experiments, as well as repeated experiments in single fields over multiple years. Finally, we consider panel data from multiple fields and multiple years to comprehensively model yield response to nitrogen.</p>
<hr>
<section id="spatial-regression-accounting-for-location-based-variability" class="level3">
<h3 class="anchored" data-anchor-id="spatial-regression-accounting-for-location-based-variability">Spatial Regression: Accounting for Location-Based Variability</h3>
<p>In the first year of the experiment, several fields were located across multiple farms and states. These fields exhibited spatial variability in yield response due to differences in soil quality, topography, and regional climate. A spatial regression model internalizes the impact of the spatial location of fields and the spatial autocorrelation structure of errors.</p>
<section id="spatial-regression-model" class="level4">
<h4 class="anchored" data-anchor-id="spatial-regression-model">Spatial Regression Model</h4>
<p>A commonly used spatial lag model (SLM) is expressed as:</p>
<p><span class="math display">\[ Y_i = \rho W Y_i + X_i \beta + \epsilon_i \]</span></p>
<p>Where: <br> - <span class="math inline">\(Y_i\)</span> = Crop yield for field <span class="math inline">\(i\)</span> <br> - <span class="math inline">\(W\)</span> = Spatial weights matrix capturing the relationship between fields <br> - <span class="math inline">\(\rho\)</span> = Spatial autocorrelation coefficient <br> - <span class="math inline">\(X_i\)</span> = Matrix of explanatory variables (e.g., nitrogen, soil quality, topography) <br> - <span class="math inline">\(\beta\)</span> = Coefficients for explanatory variables <br> - <span class="math inline">\(\epsilon_i\)</span> = Error term, assumed to be i.i.d. <br></p>
<p>The spatial weights matrix <span class="math inline">\(W\)</span> defines the structure of spatial relationships, typically based on geographic distance or field adjacency.</p>
<p>Cite: <span class="citation" data-cites="anselin2013spatial">Anselin (<a href="#ref-anselin2013spatial" role="doc-biblioref">2013</a>)</span></p>
</section>
<section id="explanation-of-spatial-autocorrelation" class="level4">
<h4 class="anchored" data-anchor-id="explanation-of-spatial-autocorrelation">Explanation of Spatial Autocorrelation</h4>
<p>Spatial regression models recognize that nearby fields are likely to have similar yields due to shared environmental conditions. This spatial autocorrelation structure mirrors the logic of time-series analysis, where observations are correlated over time.</p>
<hr>
</section>
</section>
<section id="time-series-analysis-capturing-temporal-dynamics" class="level3">
<h3 class="anchored" data-anchor-id="time-series-analysis-capturing-temporal-dynamics">Time-Series Analysis: Capturing Temporal Dynamics</h3>
<p>The logic behind time-series analysis is analogous to spatial models. Just as spatial models account for autocorrelation across fields, time-series models address autocorrelation over time. This approach is particularly relevant in single-field, multiple-year replicated experiments.</p>
<section id="time-series-regression-model" class="level4">
<h4 class="anchored" data-anchor-id="time-series-regression-model">Time-Series Regression Model</h4>
<p>An autoregressive model (AR(1)) for yield response to nitrogen can be expressed as:</p>
<p><span class="math display">\[ Y_t = \phi Y_{t-1} + X_t \beta + \epsilon_t \]</span></p>
<p>Where: <br> - <span class="math inline">\(Y_t\)</span> = Yield in year <span class="math inline">\(t\)</span> <br> - <span class="math inline">\(Y_{t-1}\)</span> = Yield in year <span class="math inline">\(t-1\)</span> (lagged yield) <br> - <span class="math inline">\(\phi\)</span> = Autoregressive coefficient capturing temporal autocorrelation <br> - <span class="math inline">\(X_t\)</span> = Matrix of explanatory variables (e.g., nitrogen, weather) <br> - <span class="math inline">\(\beta\)</span> = Coefficients for explanatory variables <br> - <span class="math inline">\(\epsilon_t\)</span> = Error term, assumed to follow <span class="math inline">\(E[\epsilon_t \epsilon_{t-s}] = \sigma^2\)</span> for <span class="math inline">\(s = 0\)</span> and 0 otherwise</p>
<p>Cite: <span class="citation" data-cites="enders2008applied">Enders (<a href="#ref-enders2008applied" role="doc-biblioref">2008</a>)</span></p>
</section>
<section id="explanation-of-temporal-autocorrelation" class="level4">
<h4 class="anchored" data-anchor-id="explanation-of-temporal-autocorrelation">Explanation of Temporal Autocorrelation</h4>
<p>Temporal autocorrelation arises when factors influencing yield (e.g., soil fertility, management practices) persist over time. Time-series models are essential for analyzing trends and year-over-year changes in yield response.</p>
<hr>
</section>
</section>
<section id="panel-data-analysis-integrating-spatial-and-temporal-dimensions" class="level3">
<h3 class="anchored" data-anchor-id="panel-data-analysis-integrating-spatial-and-temporal-dimensions">Panel Data Analysis: Integrating Spatial and Temporal Dimensions</h3>
<p>Once we have enough on-farm field experiment data collected across multiple fields and years, we can employ panel data analysis. Panel data regression incorporates both spatial and temporal dimensions, capturing time trends and spatial heterogeneity.</p>
<section id="panel-data-regression-model" class="level4">
<h4 class="anchored" data-anchor-id="panel-data-regression-model">Panel Data Regression Model</h4>
<p>A fixed-effects panel data model is expressed as:</p>
<p><span class="math display">\[ Y_{it} = \alpha_i + \delta_t + X_{it} \beta + \epsilon_{it} \]</span></p>
<p>Where: <br> - <span class="math inline">\(Y_{it}\)</span> = Yield for field <span class="math inline">\(i\)</span> in year <span class="math inline">\(t\)</span> <br> - <span class="math inline">\(\alpha_i\)</span> = Field-specific fixed effect capturing unobservable time-invariant characteristics <br> - <span class="math inline">\(\delta_t\)</span> = Year-specific fixed effect capturing time trends <br> - <span class="math inline">\(X_{it}\)</span> = Matrix of explanatory variables for field <span class="math inline">\(i\)</span> in year <span class="math inline">\(t\)</span> <br> - <span class="math inline">\(\beta\)</span> = Coefficients for explanatory variables <br> - <span class="math inline">\(\epsilon_{it}\)</span> = Error term, assumed to be i.i.d.</p>
</section>
<section id="explanation-of-panel-data-strengths" class="level4">
<h4 class="anchored" data-anchor-id="explanation-of-panel-data-strengths">Explanation of Panel Data Strengths</h4>
<p>Panel data models allow us to: <br> 1. Control for unobservable field-specific factors using <span class="math inline">\(\alpha_i\)</span>. <br> 2. Capture temporal effects like technological change or climate trends using <span class="math inline">\(\delta_t\)</span>. <br> 3. Improve estimation efficiency by leveraging variability across both fields and years. <br></p>
<hr>
</section>
</section>
<section id="handling-unbalanced-panel-data" class="level3">
<h3 class="anchored" data-anchor-id="handling-unbalanced-panel-data">Handling Unbalanced Panel Data</h3>
<p>On-farm field experiment data often present unbalanced panel structures. This imbalance arises because: - Fields differ in size, soil type, or management, leading to variability in the number of experimental plots per location (county or state level). - The number of experiments conducted each year may vary due to funding, weather conditions, or logistical constraints.</p>
<section id="challenges-of-unbalanced-panel-data" class="level4">
<h4 class="anchored" data-anchor-id="challenges-of-unbalanced-panel-data">Challenges of Unbalanced Panel Data</h4>
<ol type="1">
<li><strong>Missing Observations</strong>: Some fields or years may lack data, creating gaps in the panel.</li>
<li><strong>Heterogeneity</strong>: Unequal representation of fields or years may introduce bias in parameter estimates if not properly accounted for.</li>
<li><strong>Uneven Weights</strong>: Overrepresented fields or years may disproportionately influence regression results.</li>
</ol>
</section>
<section id="regression-model-for-unbalanced-panel-data" class="level4">
<h4 class="anchored" data-anchor-id="regression-model-for-unbalanced-panel-data">Regression Model for Unbalanced Panel Data</h4>
<p>To handle unbalanced panel data, we use a mixed-effects regression model. This model includes both fixed effects (to control for field- and time-specific factors) and random effects (to account for unobserved heterogeneity). The model can be written as:</p>
<p><span class="math display">\[ Y_{it} = \alpha_i + \delta_t + X_{it} \beta + u_i + \epsilon_{it} \]</span></p>
<p>Where: <br> - <span class="math inline">\(u_i\)</span> = Random effect for field <span class="math inline">\(i\)</span>, assumed to follow <span class="math inline">\(u_i \sim \mathcal{N}(0, \sigma_u^2)\)</span> <br> - <span class="math inline">\(\epsilon_{it}\)</span> = Random error term, assumed to follow <span class="math inline">\(\epsilon_{it} \sim \mathcal{N}(0, \sigma_\epsilon^2)\)</span> <br></p>
</section>
<section id="weighted-regression-for-unbalanced-panels" class="level4">
<h4 class="anchored" data-anchor-id="weighted-regression-for-unbalanced-panels">Weighted Regression for Unbalanced Panels</h4>
<p>An alternative approach is to apply weighted least squares (WLS) to give appropriate importance to underrepresented fields or years:</p>
<p><span class="math display">\[ \text{minimize} \quad \sum_{i=1}^N \sum_{t=1}^T w_{it} \left( Y_{it} - \alpha_i - \delta_t - X_{it} \beta \right)^2 \]</span></p>
<p>Where: <br> - <span class="math inline">\(w_{it}\)</span> = Weight for observation <span class="math inline">\((i,t)\)</span>, typically inversely proportional to the variance or frequency of observations.</p>
<p>Cite: <span class="citation" data-cites="wooldridge2019correlated">Wooldridge (<a href="#ref-wooldridge2019correlated" role="doc-biblioref">2019</a>)</span></p>
</section>
<section id="implementation-example-mixed-effects-model" class="level4">
<h4 class="anchored" data-anchor-id="implementation-example-mixed-effects-model">Implementation Example: Mixed-Effects Model</h4>
<p>The following R code demonstrates how to implement a mixed-effects model for unbalanced panel data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load necessary libraries</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lme4)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate synthetic unbalanced panel data</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">15</span>  <span class="co"># Number of fields</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="dv">5</span>   <span class="co"># Maximum number of years</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>fields <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="at">each =</span> t)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">1</span><span class="sc">:</span>t, <span class="at">times =</span> n)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>observed <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="cn">TRUE</span>, <span class="cn">FALSE</span>), n <span class="sc">*</span> t, <span class="at">replace =</span> <span class="cn">TRUE</span>, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.8</span>, <span class="fl">0.2</span>))  <span class="co"># Random missing data</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>fields <span class="ot">&lt;-</span> fields[observed]</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>years <span class="ot">&lt;-</span> years[observed]</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>nitrogen <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="fu">length</span>(fields), <span class="dv">0</span>, <span class="dv">200</span>)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>fixed_effect <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">rnorm</span>(n, <span class="dv">50</span>, <span class="dv">5</span>), <span class="at">each =</span> t)[observed]</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>yield <span class="ot">&lt;-</span> fixed_effect <span class="sc">+</span> <span class="fl">0.8</span> <span class="sc">*</span> nitrogen <span class="sc">+</span> <span class="fu">rnorm</span>(<span class="fu">length</span>(fields), <span class="dv">0</span>, <span class="dv">5</span>)</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>data_unbalanced <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Field =</span> <span class="fu">factor</span>(fields), <span class="at">Year =</span> <span class="fu">factor</span>(years), <span class="at">Nitrogen =</span> nitrogen, <span class="at">Yield =</span> yield)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a mixed-effects model</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>mixed_model <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Yield <span class="sc">~</span> Nitrogen <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> Field) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> Year), <span class="at">data =</span> data_unbalanced)</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(mixed_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: Yield ~ Nitrogen + (1 | Field) + (1 | Year)
   Data: data_unbalanced

REML criterion at convergence: 361.9

Scaled residuals: 
     Min       1Q   Median       3Q      Max 
-2.06474 -0.66317 -0.02812  0.64895  1.75602 

Random effects:
 Groups   Name        Variance Std.Dev.
 Field    (Intercept) 10.246   3.2009  
 Year     (Intercept)  0.574   0.7576  
 Residual             16.512   4.0635  
Number of obs: 60, groups:  Field, 15; Year, 5

Fixed effects:
            Estimate Std. Error t value
(Intercept)  48.0762     1.4662   32.79
Nitrogen      0.8086     0.0104   77.77

Correlation of Fixed Effects:
         (Intr)
Nitrogen -0.705</code></pre>
</div>
</div>
</section>
</section>
<section id="summary-of-model-progression" class="level3">
<h3 class="anchored" data-anchor-id="summary-of-model-progression">Summary of Model Progression</h3>
<ol type="1">
<li><strong>Spatial Regression</strong>: Captures location-based yield variability using spatial weights and autocorrelation.</li>
<li><strong>Time-Series Analysis</strong>: Accounts for temporal changes in yield response using lagged yield and explanatory variables.</li>
<li><strong>Panel Data Analysis</strong>: Integrates spatial and temporal dimensions to provide a comprehensive understanding of yield response across multiple fields and years.</li>
<li><strong>Unbalanced Panel Data</strong>: Addresses the challenges of uneven field representation and missing data using mixed-effects models or weighted regression.</li>
</ol>
<p>The progression from single-field to multi-field, multi-year analyses enables a deeper understanding of crop yield dynamics, making it possible to design policies and interventions tailored to diverse agricultural landscapes.</p>



</section>
</section>

<a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a><div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-anselin2013spatial" class="csl-entry" role="listitem">
Anselin, Luc. 2013. <em>Spatial Econometrics: Methods and Models</em>. Vol. 4. Springer Science &amp; Business Media.
</div>
<div id="ref-enders2008applied" class="csl-entry" role="listitem">
Enders, Walter. 2008. <em>Applied Econometric Time Series</em>. John Wiley &amp; Sons.
</div>
<div id="ref-hastie2017generalized" class="csl-entry" role="listitem">
Hastie, Trevor J. 2017. <span>“Generalized Additive Models.”</span> In <em>Statistical Models in s</em>, 249–307. Routledge.
</div>
<div id="ref-wood2017generalized" class="csl-entry" role="listitem">
Wood, Simon N. 2017. <em>Generalized Additive Models: An Introduction with r</em>. chapman; hall/CRC.
</div>
<div id="ref-wooldridge2019correlated" class="csl-entry" role="listitem">
Wooldridge, Jeffrey M. 2019. <span>“Correlated Random Effects Models with Unbalanced Panels.”</span> <em>Journal of Econometrics</em> 211 (1): 137–50.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/jaeseokh\.github\.io\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>